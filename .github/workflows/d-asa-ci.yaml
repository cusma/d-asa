name: Validate d-asa

on:
  workflow_call:
  pull_request:
    # If not specified, types includes by default [opened, reopened, synchronize]
    # This next line should be used in conjunction with the if statement that prevents CI jobs to run on draft PRs.
    # ready_for_review is then added to make sure that a PR with no code change triggers CI if it's no longer a draft PR.
    types: [ opened, reopened, synchronize, ready_for_review ]

permissions:
  contents: read

jobs:
  validate:
    name: Validate d-asa
    # Preventing a job from running on draft PRs.
    if: '! github.event.pull_request.draft'
    runs-on: "ubuntu-latest"
    steps:
      - name: Checkout source code
        uses: actions/checkout@v6

      - name: Set up AlgoKit
        uses: ./.github/actions/algokit-setup

      - name: Audit python dependencies
        run: algokit project run audit

      - name: Lint and format python dependencies
        run: algokit project run lint

      - name: Build smart contracts
        run: algokit project run build

      - name: Check output stability of the smart contracts
        run: algokit project run ci-teal-diff

      - name: Run deployer against LocalNet
        run: algokit project deploy localnet

  test:
    name: Test ${{ matrix.module }}
    if: '! github.event.pull_request.draft'
    runs-on: "ubuntu-latest"
    strategy:
      matrix:
        module:
          - base_d_asa
          - zero_coupon_bond
          - fixed_coupon_bond
          - perpetual_bond
    steps:
      - name: Checkout source code
        uses: actions/checkout@v6

      - name: Set up AlgoKit
        uses: ./.github/actions/algokit-setup

      - name: Detect changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            module:
              - 'smart_contracts/_helpers/**'
              - 'smart_contracts/artifacts/${{ matrix.module }}/**'
              - 'tests/conftest.py'
              - 'tests/${{ matrix.module }}/**'

      - name: Run tests
        if: steps.filter.outputs.module == 'true'
        shell: bash
        run: |
          set -o pipefail
          algokit project run test tests/${{ matrix.module }}
